customRules:
  rbac-rules.yaml: |-
    - rule: ClusterRole Binding To Anonymous User
      desc: Detect attempts to bind ClusterRoles to anonymous users
      condition: >
        ka.target.resource=clusterrolebindings and
        ka.verb=create and 
        (ka.req.binding.subjects.user_names intersects ("system:unauthenticated", "system:anonymous"))
      output: Cluster Role Binding to anonymous user (user=%ka.user.name subject=%ka.req.binding.subjects)
      priority: WARNING 
      tags: [T1098.006, rbac, access-control, persistence]
      source: k8s_audit
    - rule: ClusterRole Binding To Cluster Admin
      desc: Detect attempts to bind ClusterRoles to anonymous users
      condition: >
        ka.target.resource in ("rolebindings", "clusterrolebindings") and 
        ka.verb=create and 
        ka.req.binding.role=cluster-admin
      output: Cluster Role Binding to Cluster Admin (user=%ka.user.name subject=%ka.req.binding.subjects)
      priority: WARNING 
      tags: [T1098.006, rbac, access-control, persistence]
      source: k8s_audit
    - rule: RBAC Wildcard Permissions Detected
      desc: Detect creation or update of RBAC roles with wildcard verbs or resources
      condition: >
        ka.target.resource in ("roles", "clusterroles") and
        ka.verb in (create, update, patch) and
        (
          ka.req.role.rules.resources intersects ("*") or
          ka.req.role.rules.verbs intersects ("*")
        )
      output: >
        RBAC wildcard detected: %ka.user.name modified %ka.target.resource with wildcard permissions
      priority: CRITICAL
      source: k8s_audit
      tags: [misconfiguration, rbac, access-control, persistence]
    - rule: Namespaced SA Bound to ClusterRole
      desc: Detect RoleBindings that bind a ServiceAccount to a ClusterRole
      condition: >
        ka.target.resource in ("rolebindings", "clusterrolebindings") and
        ka.verb=create and
        (len(ka.req.binding.subjects.serviceaccount_names) > 0 or len(ka.req.binding.subjects.serviceaccount_ns_names) > 0) and
        ka.req.binding.role exists
      output: >
        Potential privilege escalation: %ka.user.name bound SA %ka.req.binding.subjects.name to ClusterRole %ka.req.binding.role
      priority: WARNING
      source: k8s_audit
      tags: [T1098.006, rbac, access-control, persistence, privilege-escalation]
