customRules:
  custom-rules.yaml: |-
    - rule: Suspicious Etcd Access
      desc: Detect any process accessing etcd client port
      condition: fd.sport=12379 and not proc.name in (kube-apiserver, kubelite, etcd)
      output: Unexpected etcd connection from %proc.name (%fd.cip:%fd.cport)
      priority: WARNING
      tags: [etcd, detection_evasion]
    - rule: ETCD Pod Tampering
      desc: Detects attempts to create, delete, or modify pod objects in etcd using etcdctl
      condition: >
        evt.type=execve and
        proc.name=etcdctl and
        (
          proc.args contains "put" or
          proc.args contains "del" or
          proc.cmdline contains "put" or
          proc.cmdline contains "del"
        ) and
        (
          proc.args contains "/registry/pods" or
          proc.cmdline contains "/registry/pods"
        )
      output: >
        Pod injection attempt via etcdctl detected
        (user=%user.name cmd=%proc.cmdline pid=%proc.pid file=%proc.exe) 
      priority: CRITICAL
      tags: [persistence, etcd, detection_evasion]
    - rule: ETCD read attempt from unusual source detected
      desc: Detects attemtps to read information from etcd
      condition: >
        evt.type=execve and
        proc.name=etcdctl and 
        (
        proc.args contains "get" or
        proc.cmdline contains "get"
        ) and
        (
          proc.args contains "/registry/pods" or
          proc.cmdline contains "/registry/pods"
        )
      output: >
        ETCD read attempt detected (user=%user.name cmd=%proc.cmdline pid=%proc.pid file=%proc.exe)
      priority: WARNING
      tags: [etcd, detection_evasion]
