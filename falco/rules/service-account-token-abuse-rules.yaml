customRules:
  serviceaccount-rules.yaml: |-
    - rule: CLI Token Usage by Local Process
      desc: Detect usage of kubectl or curl with explicit tokens
      condition: >
        evt.type = execve and
        (proc.name = "kubectl" or proc.name = "curl") and
        (proc.cmdline contains "--token" or proc.cmdline contains "Authorization: Bearer")
      output: >
        Suspicious use of kubectl or curl with token |
        user=%user.name command=%proc.cmdline container=%container.name
      priority: WARNING
      tags: [T1528, privilege_escalation, serviceaccount]
    - rule: Pod ServiceAccount Token File Access
      desc: Detect attempts to read the Kubernetes ServiceAccount token from a pod filesystem
      condition: >
        evt.is_open_read = true and
        (container.id != host) and
        fd.name = "/var/run/secrets/kubernetes.io/serviceaccount/token" and
        not proc.cmdline in ("meta-collector run", "kube-controller", "hostpath-provis", "coredns -conf /etc/coredns/Corefile", "calico-node -status-reporter", "calico-node -felix", "calico-node -allocate-tunnel-addrs")
      output: >
        Pod reading its service account token file |
        user=%user.name container=%container.name process=%proc.cmdline
      priority: WARNING
      tags: [T1528, credential_access, serviceaccount]
    - rule: Privileged or Host-Level Container Creation
      desc: Detect creation of Kubernetes pods that include privileged containers or host-level access
      condition: >
        ka.verb = "create" and
        ka.target.resource = "pods" and
        ka.req.pod.containers.privileged intersects (true) and
        not ka.user.name contains "system:serviceaccount:kube-system:"
      output: >
        Privileged or host-level container created in namespace=%ka.target.namespace
        by=%ka.user.name pod=%ka.resp.name
      priority: CRITICAL
      source: k8s_audit
      tags: [T1610, privilege-escalation, container, runtime]
